<?php
// avocado-edition/skin/board/gallery-style/write.php
// Í≥†Í∏â Í∏ÄÏì∞Í∏∞ Í∏∞Îä• (ÏãúÎ¶¨Ï¶à, Ïç∏ÎÑ§Ïùº, BGM, 19+, ÎπÑÎ∞ÄÍ∏Ä Îì±)

if (!defined('_GNUBOARD_')) exit;

// Í∂åÌïú Ï≤¥ÌÅ¨
if (!$member['mb_id']) {
    alert('ÌöåÏõêÎßå Í∏ÄÏì∞Í∏∞Í∞Ä Í∞ÄÎä•Ìï©ÎãàÎã§.');
}

// ÏàòÏ†ï Î™®ÎìúÏù∏ÏßÄ ÌôïÏù∏
$is_edit = !empty($wr_id);
$edit_data = null;

if ($is_edit) {
    $edit_sql = "SELECT * FROM {$g5['write_prefix']}{$bo_table} WHERE wr_id = '$wr_id'";
    $edit_data = sql_fetch($edit_sql);
    
    if (!$edit_data) {
        alert('Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≤åÏãúÍ∏ÄÏûÖÎãàÎã§.');
    }
    
    // Í∂åÌïú Ï≤¥ÌÅ¨
    if (!$is_admin && $member['mb_id'] !== $edit_data['mb_id']) {
        alert('ÏàòÏ†ï Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.');
    }
}

// Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
$default_category = $_GET['category'] ?? $_GET['ca_name'] ?? ($edit_data['ca_name'] ?? '');
$default_title = $edit_data['wr_subject'] ?? '';
$default_content = $edit_data['wr_content'] ?? '';
$default_episode = $edit_data['wr_1'] ?? '';
$default_bgm = $edit_data['wr_link1'] ?? '';
$default_is_secret = !empty($edit_data['wr_password']);
$default_is_adult = strpos($edit_data['wr_option'], 'adult') !== false;

// Í∏∞Ï°¥ ÌååÏùºÎì§ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏàòÏ†ï Î™®Îìú)
$existing_files = array();
if ($is_edit) {
    $file_sql = "SELECT * FROM {$g5['board_file_table']} 
                 WHERE bo_table = '$bo_table' AND wr_id = '$wr_id' 
                 ORDER BY bf_no";
    $file_result = sql_query($file_sql);
    while ($file_row = sql_fetch_array($file_result)) {
        $existing_files[] = $file_row;
    }
}

$g5['title'] = ($is_edit ? 'Í∏Ä ÏàòÏ†ï' : 'Í∏ÄÏì∞Í∏∞') . ' - ' . $board['bo_subject'];
include_once(G5_PATH.'/head.php');
?>

<style>
/* Ï†ÑÏ≤¥ Î†àÏù¥ÏïÑÏõÉ */
.write-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 30px 20px;
    background: #f8f9fa;
    min-height: 100vh;
}

.write-header {
    background: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.write-title {
    font-size: 24px;
    font-weight: 700;
    color: #333;
    margin-bottom: 10px;
}

.breadcrumb {
    color: #666;
    font-size: 14px;
}

.breadcrumb a {
    color: #007bff;
    text-decoration: none;
}

/* Ìèº ÏÑπÏÖò */
.form-section {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.section-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    font-size: 14px;
}

.form-label .required {
    color: #dc3545;
    margin-left: 4px;
}

.form-input, .form-textarea, .form-select {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.form-textarea {
    min-height: 120px;
    resize: vertical;
    line-height: 1.6;
}

.form-hint {
    font-size: 12px;
    color: #666;
    margin-top: 6px;
}

/* ÏòµÏÖò Ï≤¥ÌÅ¨Î∞ïÏä§ */
.option-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
}

.option-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkbox-input {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-label {
    font-size: 14px;
    color: #333;
    cursor: pointer;
}

.adult-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 12px;
    margin-top: 10px;
    font-size: 13px;
    color: #856404;
    display: none;
}

/* ÌååÏùº ÏóÖÎ°úÎìú */
.upload-section {
    border: 2px dashed #ddd;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    background: #fafafa;
    transition: all 0.3s;
    cursor: pointer;
    margin-bottom: 20px;
}

.upload-section:hover {
    border-color: #007bff;
    background: #f0f8ff;
}

.upload-section.dragover {
    border-color: #007bff;
    background: #e6f3ff;
    transform: scale(1.02);
}

.upload-icon {
    font-size: 48px;
    color: #999;
    margin-bottom: 15px;
}

.upload-text {
    font-size: 16px;
    color: #333;
    margin-bottom: 8px;
}

.upload-hint {
    font-size: 13px;
    color: #666;
}

.file-input {
    display: none;
}

/* ÎØ∏Î¶¨Î≥¥Í∏∞ */
.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.preview-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    position: relative;
}

.preview-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    background: #f8f9fa;
}

.preview-info {
    padding: 10px;
    font-size: 12px;
    color: #666;
}

.preview-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(220,53,69,0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 12px;
}

/* ÌäπÎ≥Ñ ÌïÑÎìú */
.image-upload-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.image-upload-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background: #fafafa;
    cursor: pointer;
    transition: all 0.3s;
}

.image-upload-item:hover {
    border-color: #007bff;
    background: #f0f8ff;
}

.image-upload-preview {
    width: 100%;
    height: 100px;
    border-radius: 6px;
    object-fit: cover;
    margin-bottom: 10px;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #999;
}

/* ÏóêÎîîÌÑ∞ */
.editor-container {
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.editor-toolbar {
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    padding: 10px 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.editor-btn {
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.editor-btn:hover {
    background: #e9ecef;
}

/* Ïï°ÏÖò Î≤ÑÌäº */
.action-section {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    text-align: center;
}

.action-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

/* Î∞òÏùëÌòï */
@media (max-width: 768px) {
    .write-container {
        padding: 15px;
    }
    
    .form-row, .image-upload-group {
        grid-template-columns: 1fr;
    }
    
    .option-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<div class="write-container">
    <!-- Ìó§Îçî -->
    <div class="write-header">
        <div class="breadcrumb">
            <a href="<?php echo G5_URL ?>">Ìôà</a> > 
            <a href="<?php echo G5_BBS_URL ?>/board.php?bo_table=<?php echo $bo_table ?>"><?php echo $board['bo_subject'] ?></a> > 
            <?php echo $is_edit ? 'Í∏Ä ÏàòÏ†ï' : 'Í∏ÄÏì∞Í∏∞' ?>
        </div>
        <h1 class="write-title">
            <?php echo $is_edit ? '‚úèÔ∏è Í∏Ä ÏàòÏ†ï' : '‚úçÔ∏è ÏÉà Í∏Ä ÏûëÏÑ±' ?>
        </h1>
    </div>

    <form name="fwrite" id="fwrite" action="<?php echo G5_BBS_URL ?>/write_update.php" method="post" enctype="multipart/form-data">
        <input type="hidden" name="bo_table" value="<?php echo $bo_table ?>">
        <input type="hidden" name="w" value="<?php echo $w ?>">
        <input type="hidden" name="wr_id" value="<?php echo $wr_id ?>">
        <input type="hidden" name="sca" value="<?php echo $sca ?>">
        <input type="hidden" name="sfl" value="<?php echo $sfl ?>">
        <input type="hidden" name="stx" value="<?php echo $stx ?>">
        <input type="hidden" name="spt" value="<?php echo $spt ?>">
        <input type="hidden" name="sst" value="<?php echo $sst ?>">
        <input type="hidden" name="sod" value="<?php echo $sod ?>">
        <input type="hidden" name="page" value="<?php echo $page ?>">

        <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑπÏÖò -->
        <div class="form-section">
            <h3 class="section-title">üìù Í∏∞Î≥∏ Ï†ïÎ≥¥</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="ca_name" class="form-label">ÏãúÎ¶¨Ï¶à (Ïπ¥ÌÖåÍ≥†Î¶¨) <span class="required">*</span></label>
                    <input type="text" name="ca_name" id="ca_name" class="form-input" 
                           value="<?php echo $default_category ?>" 
                           placeholder="Ïòà: ÎÇ¥ ÏõπÌà∞ Ï†úÎ™©" required>
                    <div class="form-hint">ÏãúÎ¶¨Ï¶àÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî. Í∞ôÏùÄ ÏãúÎ¶¨Ï¶àÏùò ÏûëÌíàÎì§Ïù¥ Ìï®Íªò Î¨∂ÏûÖÎãàÎã§.</div>
                </div>
                
                <div class="form-group">
                    <label for="wr_1" class="form-label">ÌöåÏ∞®</label>
                    <input type="number" name="wr_1" id="wr_1" class="form-input" 
                           value="<?php echo $default_episode ?>" 
                           placeholder="ÌöåÏ∞® Î≤àÌò∏" min="1">
                    <div class="form-hint">ÌöåÏ∞® Î≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî. (ÏÑ†ÌÉùÏÇ¨Ìï≠)</div>
                </div>
            </div>

            <div class="form-group">
                <label for="wr_subject" class="form-label">Ï†úÎ™© <span class="required">*</span></label>
                <input type="text" name="wr_subject" id="wr_subject" class="form-input" 
                       value="<?php echo $default_title ?>" 
                       placeholder="Ìè¨Ïä§Ìä∏ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required>
            </div>

            <div class="form-group">
                <label for="wr_2" class="form-label">Ï†úÎ™© (ÏòÅÎ¨∏)</label>
                <input type="text" name="wr_2" id="wr_2" class="form-input" 
                       value="<?php echo $edit_data['wr_2'] ?? '' ?>" 
                       placeholder="English Title (ÏÑ†ÌÉùÏÇ¨Ìï≠)">
            </div>

            <div class="form-group">
                <label for="wr_3" class="form-label">ÏÜåÍ∞ú</label>
                <textarea name="wr_3" id="wr_3" class="form-textarea" 
                          placeholder="ÏûëÌíàÏù¥ÎÇò ÏãúÎ¶¨Ï¶à ÏÜåÍ∞úÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"><?php echo $edit_data['wr_3'] ?? '' ?></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="wr_4" class="form-label">Ïû•Î•¥</label>
                    <input type="text" name="wr_4" id="wr_4" class="form-input" 
                           value="<?php echo $edit_data['wr_4'] ?? '' ?>" 
                           placeholder="ÌåêÌÉÄÏßÄ, Î°úÎß®Ïä§, Ïï°ÏÖò Îì±">
                </div>
                
                <div class="form-group">
                    <label for="wr_5" class="form-label">ÌÇ§ÏõåÎìú</label>
                    <input type="text" name="wr_5" id="wr_5" class="form-input" 
                           value="<?php echo $edit_data['wr_5'] ?? '' ?>" 
                           placeholder="#ÌÉúÍ∑∏1 #ÌÉúÍ∑∏2 #ÌÉúÍ∑∏3">
                    <div class="form-hint"># Í∏∞Ìò∏Î•º ÏÇ¨Ïö©Ìï¥ÏÑú ÌÉúÍ∑∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</div>
                </div>
            </div>
        </div>

        <!-- Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏÑπÏÖò -->
        <div class="form-section">
            <h3 class="section-title">üñºÔ∏è Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï</h3>
            
            <div class="image-upload-group">
                <div class="form-group">
                    <label class="form-label">ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ (Ïç∏ÎÑ§Ïùº)</label>
                    <div class="image-upload-item" onclick="document.getElementById('thumbnailInput').click()">
                        <div class="image-upload-preview" id="thumbnailPreview">üì∑</div>
                        <div>ÌÅ¥Î¶≠ÌïòÏó¨ Ïç∏ÎÑ§Ïùº ÏóÖÎ°úÎìú</div>
                        <input type="file" id="thumbnailInput" name="thumbnail" accept="image/*" class="file-input" onchange="previewThumbnail(this)">
                    </div>
                    <div class="form-hint">ÏãúÎ¶¨Ï¶à Î™©Î°ùÏóêÏÑú ÌëúÏãúÎê† Ïç∏ÎÑ§Ïùº Ïù¥ÎØ∏ÏßÄÏûÖÎãàÎã§.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ</label>
                    <div class="image-upload-item" onclick="document.getElementById('backgroundInput').click()">
                        <div class="image-upload-preview" id="backgroundPreview">üé®</div>
                        <div>ÌÅ¥Î¶≠ÌïòÏó¨ Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</div>
                        <input type="file" id="backgroundInput" name="background" accept="image/*" class="file-input" onchange="previewBackground(this)">
                    </div>
                    <div class="form-hint">ÏãúÎ¶¨Ï¶à ÌéòÏù¥ÏßÄÏùò Î∞∞Í≤ΩÏúºÎ°ú ÏÇ¨Ïö©Îê©ÎãàÎã§.</div>
                </div>
            </div>

            <div class="form-group">
                <label for="wr_6" class="form-label">Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ URL</label>
                <input type="url" name="wr_6" id="wr_6" class="form-input" 
                       value="<?php echo $edit_data['wr_6'] ?? '' ?>" 
                       placeholder="https://example.com/background.jpg">
                <div class="form-hint">Ïô∏Î∂Ä Ïù¥ÎØ∏ÏßÄ URLÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÏúÑÏóêÏÑú ÏßÅÏ†ë ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.</div>
            </div>
        </div>

        <!-- Î≥∏Î¨∏ ÌååÏùº ÏóÖÎ°úÎìú -->
        <div class="form-section">
            <h3 class="section-title">üìÅ ÌååÏùº ÏóÖÎ°úÎìú</h3>
            
            <div class="upload-section" id="fileUploadZone">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</div>
                <div class="upload-hint">
                    Ïù¥ÎØ∏ÏßÄ, ÎèôÏòÅÏÉÅ, Î¨∏ÏÑú Îì±ÏùÑ ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§<br>
                    <small>ÏµúÎåÄ 10MB, Ïó¨Îü¨ ÌååÏùº ÎèôÏãú ÏóÖÎ°úÎìú Í∞ÄÎä•</small>
                </div>
                <input type="file" id="fileInput" name="bf_file[]" multiple class="file-input">
            </div>

            <div class="preview-grid" id="filePreviewGrid">
                <!-- ÏóÖÎ°úÎìúÎêú ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
        </div>

        <!-- Î≥∏Î¨∏ ÏûëÏÑ± -->
        <div class="form-section">
            <h3 class="section-title">üìÑ Î≥∏Î¨∏ ÏûëÏÑ±</h3>
            
            <div class="editor-container">
                <div class="editor-toolbar">
                    <button type="button" class="editor-btn" onclick="insertText('**', '**')"><strong>B</strong></button>
                    <button type="button" class="editor-btn" onclick="insertText('*', '*')"><em>I</em></button>
                    <button type="button" class="editor-btn" onclick="insertText('~~', '~~')"><del>S</del></button>
                    <button type="button" class="editor-btn" onclick="insertText('\n# ', '')">H1</button>
                    <button type="button" class="editor-btn" onclick="insertText('\n## ', '')">H2</button>
                    <button type="button" class="editor-btn" onclick="insertText('\n- ', '')">Î™©Î°ù</button>
                    <button type="button" class="editor-btn" onclick="insertText('\n> ', '')">Ïù∏Ïö©</button>
                    <button type="button" class="editor-btn" onclick="insertText('\n```\n', '\n```')">ÏΩîÎìú</button>
                </div>
                <textarea name="wr_content" id="wr_content" class="form-textarea" 
                          style="border: none; border-radius: 0; min-height: 300px;"
                          placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."><?php echo $default_content ?></textarea>
            </div>
            <div class="form-hint">ÎßàÌÅ¨Îã§Ïö¥ Î¨∏Î≤ïÏùÑ ÏßÄÏõêÌï©ÎãàÎã§. ÏúÑ Î≤ÑÌäºÎì§ÏùÑ ÌôúÏö©Ìï¥Î≥¥ÏÑ∏Ïöî!</div>
        </div>

        <!-- BGM ÏÑ§Ï†ï -->
        <div class="form-section">
            <h3 class="section-title">üéµ Î∞∞Í≤ΩÏùåÏïÖ (BGM)</h3>
            
            <div class="form-group">
                <label for="wr_link1" class="form-label">BGM URL</label>
                <input type="url" name="wr_link1" id="wr_link1" class="form-input" 
                       value="<?php echo $default_bgm ?>" 
                       placeholder="https://example.com/bgm.mp3">
                <div class="form-hint">MP3, WAV Îì±Ïùò Ïò§ÎîîÏò§ ÌååÏùº URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî. Ìè¨Ïä§Ìä∏ Ï°∞Ìöå Ïãú ÏûêÎèôÏúºÎ°ú Ïû¨ÏÉùÎê©ÎãàÎã§.</div>
            </div>
        </div>

        <!-- ÏòµÏÖò ÏÑ§Ï†ï -->
        <div class="option-section">
            <h3 class="section-title">‚öôÔ∏è ÏòµÏÖò</h3>
            
            <div class="option-grid">
                <div class="checkbox-group">
                    <input type="checkbox" id="secretPost" name="secret_post" class="checkbox-input" 
                           <?php echo $default_is_secret ? 'checked' : '' ?>>
                    <label for="secretPost" class="checkbox-label">üîí ÎπÑÎ∞ÄÍ∏Ä</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="adultContent" name="adult_content" class="checkbox-input" 
                           <?php echo $default_is_adult ? 'checked' : '' ?> onchange="toggleAdultWarning()">
                    <label for="adultContent" class="checkbox-label">üîû 19Í∏à ÏΩòÌÖêÏ∏†</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="allowComment" name="allow_comment" class="checkbox-input" checked>
                    <label for="allowComment" class="checkbox-label">üí¨ ÎåìÍ∏Ä ÌóàÏö©</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="useHtml" name="use_html" class="checkbox-input" checked>
                    <label for="useHtml" class="checkbox-label">üìù HTML ÏÇ¨Ïö©</label>
                </div>
            </div>

            <div class="adult-warning" id="adultWarning">
                <strong>‚ö†Ô∏è Ï£ºÏùò:</strong> 19Í∏à ÏΩòÌÖêÏ∏†Î°ú ÌëúÏãúÎêú Í≤åÏãúÎ¨ºÏùÄ ÏùºÎ∞ò ÏÇ¨Ïö©ÏûêÏóêÍ≤åÎäî Ï†úÌïúÏ†ÅÏúºÎ°ú ÌëúÏãúÎê©ÎãàÎã§.
                Í¥ÄÎ†® Î≤ïÎ†πÏùÑ Ï§ÄÏàòÌïòÏó¨ Ï†ÅÏ†àÌïú ÏΩòÌÖêÏ∏†Îßå ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.
            </div>

            <div class="form-group" id="secretPasswordGroup" style="display: none; margin-top: 20px;">
                <label for="wr_password" class="form-label">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                <input type="password" name="wr_password" id="wr_password" class="form-input" 
                       placeholder="ÎπÑÎ∞ÄÍ∏Ä ÎπÑÎ∞ÄÎ≤àÌò∏ (4Ïûê Ïù¥ÏÉÅ)" minlength="4">
                <div class="form-hint">ÎπÑÎ∞ÄÍ∏ÄÎ°ú ÏÑ§Ï†ï Ïãú Ïù¥ ÎπÑÎ∞ÄÎ≤àÌò∏Î°ú Î≥¥Ìò∏Îê©ÎãàÎã§.</div>
            </div>
        </div>

        <!-- Ïï°ÏÖò Î≤ÑÌäº -->
        <div class="action-section">
            <div class="action-buttons">
                <a href="<?php echo G5_BBS_URL ?>/board.php?bo_table=<?php echo $bo_table ?>" class="btn btn-secondary">
                    ‚ùå Ï∑®ÏÜå
                </a>
                
                <button type="button" class="btn btn-success" onclick="previewPost()">
                    üëÅÔ∏è ÎØ∏Î¶¨Î≥¥Í∏∞
                </button>
                
                <button type="submit" class="btn btn-primary">
                    <?php echo $is_edit ? 'üíæ ÏàòÏ†ïÌïòÍ∏∞' : 'üìù Î∞úÌñâÌïòÍ∏∞' ?>
                </button>
            </div>
        </div>
    </form>
</div>

<script>
let uploadedFiles = [];

// ÌååÏùº ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠
const fileUploadZone = document.getElementById('fileUploadZone');
const fileInput = document.getElementById('fileInput');

fileUploadZone.addEventListener('click', () => fileInput.click());

fileUploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUploadZone.classList.add('dragover');
});

fileUploadZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    fileUploadZone.classList.remove('dragover');
});

fileUploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUploadZone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

// ÌååÏùº Ï≤òÎ¶¨
function handleFiles(files) {
    Array.from(files).forEach(file => {
        if (file.size > 10 * 1024 * 1024) {
            alert(`${file.name}ÏùÄ 10MBÎ•º Ï¥àÍ≥ºÌï©ÎãàÎã§.`);
            return;
        }
        
        uploadedFiles.push(file);
        addFilePreview(file);
    });
}

// ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ Ï∂îÍ∞Ä
function addFilePreview(file) {
    const previewGrid = document.getElementById('filePreviewGrid');
    const previewItem = document.createElement('div');
    previewItem.className = 'preview-item';
    
    const isImage = file.type.startsWith('image/');
    const fileURL = URL.createObjectURL(file);
    
    previewItem.innerHTML = `
        ${isImage ? 
            `<img src="${fileURL}" class="preview-image" alt="${file.name}">` :
            `<div class="preview-image" style="display: flex; align-items: center; justify-content: center; font-size: 24px;">üìÑ</div>`
        }
        <div class="preview-info">
            <div style="font-weight: 600; margin-bottom: 4px;">${file.name}</div>
            <div>${(file.size / 1024 / 1024).toFixed(2)}MB</div>
        </div>
        <button type="button" class="preview-remove" onclick="removeFile(this, '${file.name}')">√ó</button>
    `;
    
    previewGrid.appendChild(previewItem);
}

// ÌååÏùº Ï†úÍ±∞
function removeFile(button, fileName) {
    uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
    button.closest('.preview-item').remove();
}

// Ïç∏ÎÑ§Ïùº ÎØ∏Î¶¨Î≥¥Í∏∞
function previewThumbnail(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('thumbnailPreview').innerHTML = 
                `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞
function previewBackground(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('backgroundPreview').innerHTML = 
                `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// 19Í∏à Í≤ΩÍ≥† ÌÜ†Í∏Ä
function toggleAdultWarning() {
    const checkbox = document.getElementById('adultContent');
    const warning = document.getElementById('adultWarning');
    warning.style.display = checkbox.checked ? 'block' : 'none';
}

// ÎπÑÎ∞ÄÍ∏Ä ÎπÑÎ∞ÄÎ≤àÌò∏ ÌÜ†Í∏Ä
document.getElementById('secretPost').addEventListener('change', function() {
    const passwordGroup = document.getElementById('secretPasswordGroup');
    passwordGroup.style.display = this.checked ? 'block' : 'none';
    
    if (this.checked) {
        document.getElementById('wr_password').required = true;
    } else {
        document.getElementById('wr_password').required = false;
    }
});

// ÏóêÎîîÌÑ∞ ÌÖçÏä§Ìä∏ ÏÇΩÏûÖ
function insertText(before, after) {
    const textarea = document.getElementById('wr_content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    const newText = before + selectedText + after;
    textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
    
    // Ïª§ÏÑú ÏúÑÏπò Ï°∞Ï†ï
    const newCursorPos = start + before.length + selectedText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
}

// ÎØ∏Î¶¨Î≥¥Í∏∞
function previewPost() {
    const form = document.getElementById('fwrite');
    const originalAction = form.action;
    const originalTarget = form.target;
    
    form.action = '<?php echo G5_BBS_URL ?>/preview.php';
    form.target = '_blank';
    form.submit();
    
    form.action = originalAction;
    form.target = originalTarget;
}

// Ìèº Ï†úÏ∂ú Ï†Ñ Í≤ÄÏ¶ù
document.getElementById('fwrite').addEventListener('submit', function(e) {
    const category = document.getElementById('ca_name').value.trim();
    const title = document.getElementById('wr_subject').value.trim();
    const content = document.getElementById('wr_content').value.trim();
    
    if (!category) {
        alert('ÏãúÎ¶¨Ï¶à(Ïπ¥ÌÖåÍ≥†Î¶¨)Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        e.preventDefault();
        return;
    }
    
    if (!title) {
        alert('Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        e.preventDefault();
        return;
    }
    
    if (!content) {
        alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        e.preventDefault();
        return;
    }
    
    // ÎπÑÎ∞ÄÍ∏Ä ÎπÑÎ∞ÄÎ≤àÌò∏ Í≤ÄÏ¶ù
    const isSecret = document.getElementById('secretPost').checked;
    const password = document.getElementById('wr_password').value;
    
    if (isSecret && password.length < 4) {
        alert('ÎπÑÎ∞ÄÍ∏Ä ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
        e.preventDefault();
        return;
    }
});

// Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', function() {
    // 19Í∏à Ï≤¥ÌÅ¨ ÏÉÅÌÉúÏóê Îî∞Î•∏ Í≤ΩÍ≥† ÌëúÏãú
    toggleAdultWarning();
    
    // ÎπÑÎ∞ÄÍ∏Ä Ï≤¥ÌÅ¨ ÏÉÅÌÉúÏóê Îî∞Î•∏ ÎπÑÎ∞ÄÎ≤àÌò∏ ÌïÑÎìú ÌëúÏãú
    const secretCheckbox = document.getElementById('secretPost');
    if (secretCheckbox.checked) {
        document.getElementById('secretPasswordGroup').style.display = 'block';
        document.getElementById('wr_password').required = true;
    }
});
</script>

<?php include_once(G5_PATH.'/tail.php'); ?>
